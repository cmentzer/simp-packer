{
    "__": " Sooper dooper brand-new SIMP Packer manifest                      ",
    "__": "                                                                   ",
    "__": " USAGE:                                                            ",
    "__": "   `~/bin/packer build -var-file=vars.json simp.json`              ",
    "__": "                                                                   ",
    "__": " NOTES:                                                            ",
    "__": "   - The first `<wait10>`s are killing time until SSH can connect  ",

  "builders": [
    {
      "type": "virtualbox-iso",
      "guest_os_type": "RedHat_64",
      "iso_url": "{{user `iso_url`}}",
      "iso_checksum": "{{user `iso_checksum`}}",
      "iso_checksum_type": "{{user `iso_checksum_type`}}",
      "disk_size": "{{user `disk_size`}}",
      "http_directory": "./",
      "vboxmanage": [
        ["modifyvm", "{{.Name}}", "--memory", "{{user `memory_amt`}}"],
        ["modifyvm", "{{.Name}}", "--cpus", "{{user `cpu_count`}}"]
      ],

      "format": "ova",

      "ssh_username": "packer",
      "ssh_password": "packer",
      "ssh_wait_timeout": "900s",

      "ssh_host_port_min": 2222,
      "ssh_host_port_max": 2222,

      "boot_wait": "10s",
      "boot_command": [
        "<wait>",
        "vmlinuz inst.ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/ks.cfg initrd=initrd.img fips=0",
        "<enter><wait>"
       ],
      "shutdown_command": "echo 'packer' | sudo -S shutdown -P now"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "remote_path": "/var/local/packer/update.sh",
      "execute_command": "sudo chmod +x {{.Path}}; {{.Vars}} sudo bash '{{.Path}}'",
      "inline": [
        "yum update -y",
        "yum install -y gcc make kernel-headers kernel-devel tree htop ncdu dkms"
      ]
    },
    {
      "type": "shell",
      "remote_path": "/var/local/packer/firewall-setup.sh",
      "execute_command": "sudo chmod +x {{.Path}}; {{.Vars}} sudo bash '{{.Path}}'",
      "inline": [
        "systemctl stop firewalld",
        "systemctl disable firewalld"
      ]
    },
    {
      "type": "shell",
      "remote_path": "/var/local/packer/cloud-init.sh",
      "execute_command": "sudo chmod +x {{.Path}}; {{.Vars}} sudo bash '{{.Path}}'",
      "inline": [
        "yum install -y cloud-init"
      ]
    },
    {
      "type": "shell",
      "remote_path": "/var/local/packer/set-packer-ssh-stuff.sh",
      "execute_command": "sudo chmod +x {{.Path}}; {{.Vars}} sudo bash '{{.Path}}'",
      "inline": [
        "mkdir /var/local/packer/.ssh",
        "chown packer:packer /var/local/packer/.ssh",
        "chmod 750 /var/local/packer/.ssh",
        "touch /var/local/packer/.ssh/authorized_keys",
        "chown packer:packer /var/local/packer/.ssh/authorized_keys",
        "chmod 640 /var/local/packer/.ssh/authorized_keys",
        "echo {{user `ssh_pub_key`}} >> /var/local/packer/.ssh/authorized_keys",

        "chcon -R -t ssh_home_t /var/local/packer/.ssh/"
      ]
    },
    {
      "type": "shell",
      "remote_path": "/var/local/packer/create-ec2-conf-directory",
      "execute_command": "sudo chmod +x {{.Path}}; {{.Vars}} sudo bash '{{.Path}}'",
      "inline": [
        "mkdir /usr/share/simp/modules/site/manifests/simp",
        "chown root:root /usr/share/simp/modules/site/manifests/simp"
      ]
    },
    {
      "type": "file",
      "source": "files/ec2_init.pp",
      "destination": "/var/local/packer/ec2_init.pp"
    },
    {
      "type": "shell",
      "remote_path": "/var/local/packer/move-ec2_init",
      "execute_command": "sudo chmod +x {{.Path}}; {{.Vars}} sudo bash '{{.Path}}'",
      "inline": [
        "mv /var/local/packer/ec2_init.pp /usr/share/simp/modules/site/manifests/simp/ec2_init.pp",
        "chown -R root:root /usr/share/simp/modules/site/manifests/simp"
      ]
    },
    {
      "type": "file",
      "source": "files/hieradata.yaml",
      "destination": "/var/local/packer/hieradata.yaml"
    },
    {
      "type": "shell",
      "remote_path": "/var/local/packer/hieradata",
      "execute_command": "sudo chmod +x {{.Path}}; {{.Vars}} sudo bash '{{.Path}}'",
      "inline": [
        "mv -f /var/local/packer/hieradata.yaml /usr/share/simp/environments/simp/hieradata/hosts/puppet.your.domain.yaml",
        "chown root:puppet /usr/share/simp/environments/simp/hieradata/hosts/puppet.your.domain.yaml"
      ]
    },
    {
      "type": "shell",
      "remote_path": "/var/local/packer/remove_local_repo",
      "execute_command": "sudo chmod +x {{.Path}}; {{.Vars}} sudo bash '{{.Path}}'",
      "inline": [
        "rm -f /etc/yum.repos.d/simp_filesystem.repo"
      ]
      
    },
    {
      "type": "file",
      "source": "files/simp_conf.yaml",
      "destination": "/var/local/packer/simp_conf.yaml"
    },
    {
      "type": "shell",
      "remote_path": "/var/local/packer/move-simp-conf",
      "execute_command": "sudo chmod +x {{.Path}}; {{.Vars}} sudo bash '{{.Path}}'",
      "inline": [
        "mv -f /var/local/packer/simp_conf.yaml /usr/share/simp/simp_conf.yaml"
      ]
    },
    {
      "type": "file",
      "source": "files/generate_answers.sh",
      "destination": "/var/local/packer/generate_answers.sh"
    },
    {
      "type": "shell",
      "remote_path": "/var/local/packer/move-generate-answers",
      "execute_command": "sudo chmod +x {{.Path}}; {{.Vars}} sudo bash '{{.Path}}'",
      "inline": [
        "mv -f /var/local/packer/generate_answers.sh /usr/share/simp/generate_answers.sh"
      ]
    },
    {
      "type": "file",
      "source": "files/cloud.cfg",
      "destination": "/var/local/packer/cloud.cfg"
    },
    {
      "type": "shell",
      "remote_path": "/var/local/packer/move-cloud-cfg",
      "execute_command": "sudo chmod +x {{.Path}}; {{.Vars}} sudo bash '{{.Path}}'",
      "inline": [
        "mv -f /var/local/packer/cloud.cfg /etc/cloud/cloud.cfg",
        "chown root:root /etc/cloud/cloud.cfg"
      ]
    },
    {
      "type": "file",
      "source": "files/sshd_config",
      "destination": "/var/local/packer/sshd_config"
    },
    {
      "type": "shell",
      "remote_path": "/var/local/packer/move-sshd_config",
      "execute_command": "sudo chmod +x {{.Path}}; {{.Vars}} sudo bash '{{.Path}}'",
      "inline": [
        "mv -f /var/local/packer/sshd_config /etc/ssh/sshd_config",
        "chown root:root /etc/ssh/sshd_config"
      ]
    },
    {
      "type": "shell",
      "remote_path": "/var/local/packer/remove-users",
      "execute_command": "sudo chmod +x {{.Path}}; {{.Vars}} sudo bash '{{.Path}}'",
      "inline": [
        "/opt/puppetlabs/bin/puppet resource user simp managehome=true ensure=absent"
      ]
    },
    {
      "type": "file",
      "source": "files/remove_packer_user.sh",
      "destination": "/var/local/packer/remove_packer_user.sh"
    },
    {
      "type": "shell",
      "remote_path": "/var/local/packer/remove_packer",
      "execute_command": "sudo chmod +x {{.Path}}; {{.Vars}} sudo bash '{{.Path}}'",
      "inline": [
        "mv -f /var/local/packer/remove_packer_user.sh /etc/init.d/remove_packer_user.sh",
        "chown root:root /etc/init.d/remove_packer_user.sh",
        "chkconfig --add /etc/init.d/remove_packer_user.sh"
      ]
    }
  ],
  "post-processors": []
}
